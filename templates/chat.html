<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FastChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gradient-to-b from-purple-950 to-purple-800 text-gray-100 font-sans"
  >
    <div id="login-section" class="flex items-center justify-center h-screen">
      <div class="bg-purple-900 p-8 rounded-lg shadow-lg w-full max-w-sm">
        <img
          src="/static/logo.png"
          alt="FastChat Logo"
          class="w-36 mx-auto mb-6"
        />

        <h2 class="text-xl font-bold text-center mb-6">Login</h2>
        <form action="" onsubmit="login(event)">
          <div class="mb-4">
            <label for="email" class="block mb-2 text-sm font-medium"
              >Your e-mail</label
            >
            <input
              type="email"
              id="email"
              class="bg-purple-800 border border-purple-600 text-white text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5"
              placeholder="you@email.com"
              required
            />
          </div>
          <div class="mb-6">
            <label for="password" class="block mb-2 text-sm font-medium"
              >Your password</label
            >
            <input
              type="password"
              id="password"
              class="bg-purple-800 border border-purple-600 text-white text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block w-full p-2.5"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full text-white bg-purple-700 hover:bg-purple-600 focus:ring-4 focus:outline-none focus:ring-purple-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center"
          >
            Enter
          </button>
        </form>
        <p class="mt-4 text-center text-sm text-gray-400">
          Dont have an account?
          <a
            href="/auth/register"
            class="font-medium text-purple-400 hover:underline"
          >
            Register
          </a>
        </p>
      </div>
    </div>

    <div
      id="chat-section"
      style="display: none"
      class="max-w-4xl mx-auto h-screen flex flex-col bg-purple-900/50 shadow-2xl"
    >
      <header
        class="bg-purple-950/50 backdrop-blur-sm p-4 border-b border-purple-700"
      >
        <h1 class="text-xl font-bold">FastChat</h1>
        <h2 id="welcome-message" class="text-sm text-purple-300"></h2>
      </header>

      <main
        id="messages"
        class="flex-grow p-6 space-y-4 overflow-y-auto"
      ></main>

      <footer class="bg-purple-950 p-4 border-t border-purple-700">
        <form class="flex items-center" onsubmit="sendMessage(event)">
          <input
            type="text"
            id="messageText"
            class="flex-grow bg-purple-800 border-none rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Write your message..."
            autocomplete="off"
          />
          <button
            type="submit"
            class="ml-4 bg-purple-600 hover:bg-purple-500 rounded-full px-6 py-2 text-white font-semibold"
          >
            Send
          </button>
        </form>
      </footer>
    </div>

    <script>
      let ws = null;

      async function login(event) {
        event.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const formData = new FormData();
        formData.append("username", email);
        formData.append("password", password);

        const response = await fetch("/auth/login", {
          method: "POST",
          body: formData,
        });

        if (response.ok) {
          const data = await response.json();
          localStorage.setItem("access_token", data.access_token);

          document.getElementById("login-section").style.display = "none";
          document.getElementById("chat-section").style.display = "flex";

          connectToChat();
        } else {
          alert("Login failed. Check your credentials.");
        }
      }

      function connectToChat() {
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Token not found. Please log in first.");
          return;
        }

        ws = new WebSocket(`ws://localhost:8000/chat/ws?token=${token}`);

        ws.onopen = function () {
          fetch("/auth/users/me", {
            headers: { Authorization: `Bearer ${token}` },
          })
            .then((res) => res.json())
            .then((data) => {
              document.getElementById(
                "welcome-message"
              ).textContent = `Welcome, ${data.username}!`;
            });
        };

        ws.onmessage = function (event) {
          const messageData = JSON.parse(event.data);
          const messagesContainer = document.getElementById("messages");

          const messageElement = document.createElement("div");
          messageElement.classList.add(
            "flex",
            "flex-col",
            "items-start",
            "max-w-lg"
          );

          const senderElement = document.createElement("div");
          senderElement.classList.add(
            "font-bold",
            "text-purple-300",
            "text-sm"
          );
          senderElement.textContent = messageData.sender;

          const textElement = document.createElement("div");
          textElement.classList.add(
            "bg-purple-800",
            "rounded-lg",
            "p-3",
            "mt-1"
          );
          textElement.textContent = messageData.message;

          messageElement.appendChild(senderElement);
          messageElement.appendChild(textElement);
          messagesContainer.appendChild(messageElement);

          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };
      }

      function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById("messageText");
        if (input.value) {
          const messageToSend = { text: input.value };
          ws.send(JSON.stringify(messageToSend));
          input.value = "";
        }
      }

      if (localStorage.getItem("access_token")) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("chat-section").style.display = "flex";
        connectToChat();
      }
    </script>
  </body>
</html>
